<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>≈†koln√≠ knihovna ‚Äì v√Ωp≈Øjƒçky a vratky</title>

<!-- QR skener -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"
        onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js';document.head.appendChild(s);})();">
</script>
<style>
  :root{
    --bg1:#6b63ff; --bg2:#6aa5ff; --card:#fff; --text:#111827;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text); background:linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
    min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:100%; max-width:480px}
  .title{color:#fff; text-align:center; margin-bottom:14px}
  .title h1{margin:0; font-size:28px}
  .subtitle{opacity:.95; font-size:14px}

  .card{
    background:var(--card); border-radius:18px; padding:18px; box-shadow:0 12px 28px rgba(0,0,0,.15);
    margin-bottom:14px;
  }
  .step-title{font-size:22px; font-weight:800; margin:0 0 12px}
  .big-emoji{font-size:64px; text-align:center; margin:4px 0 8px}
  .muted{opacity:.75; font-size:12px}

  .input{width:100%; font-size:18px; padding:14px 16px; border-radius:14px; border:2px solid #e5e7eb; outline:none}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px; width:100%;
    padding:14px 16px; border-radius:14px; border:none; cursor:pointer; font-size:18px; font-weight:700;
    background:#22c55e; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.12); transition:transform .06s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-secondary{background:#f3f4f6; color:#111}
  .actions{display:flex; gap:12px}
  .action{flex:1; padding:16px; border-radius:16px; background:#f3f4f6; text-align:center; cursor:pointer; user-select:none}
  .action .emoji{font-size:44px}
  .action .label{margin-top:6px; font-weight:800; font-size:18px}
  .action.borrow{background:#ecfdf5}
  .action.return{background:#eff6ff}
  .btn-ok{background:#111827; color:#fff}

  #scanner{display:none}
  #qr-region{width:100%; border-radius:16px; overflow:hidden; background:#000}
  #qr-instructions{font-size:14px; opacity:.8; text-align:center; margin:10px 0 0}

  .hidden{display:none!important}
  .hint{color:#fff; text-align:center; font-size:12px; opacity:.9; margin-bottom:8px}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:20px; z-index:20}
  .modal-card{width:100%; max-width:420px; background:#fff; border-radius:18px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); text-align:center}
  .modal h3{margin:6px 0 10px; font-size:21px}
  .toast{position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; font-weight:600; z-index:30}
</style>
</head>
<body>
<div class="app">
  <div class="title">
    <div style="font-size:38px">üìö</div>
    <h1>≈†koln√≠ knihovna</h1>
    <div class="subtitle">P≈Øjƒçov√°n√≠ a vracen√≠ pomoc√≠ QR k√≥d≈Ø</div>
  </div>

  <!-- 1) ≈Ω√ÅK -->
  <div id="step-student" class="card">
    <h2 class="step-title">1. Kdo si p≈Øjƒçuje/vrac√≠?</h2>
    <div class="big-emoji">üë§</div>
    <input id="studentInput" class="input" placeholder="Napi≈° nebo naskenuj: Jm√©no P≈ô√≠jmen√≠|T≈ô√≠da (nap≈ô. Jakub Nov√°k|5.B)" autocomplete="off">
    <div style="height:10px"></div>
    <button id="scanStudentBtn" class="btn">üì∑ Skenovat QR k√≥d ≈æ√°ka</button>
    <div id="studentPreview" class="muted hidden" style="margin-top:8px"></div>
  </div>

  <!-- 2) AKCE -->
  <div id="step-action" class="card hidden">
    <h2 class="step-title">2. Co chce≈° udƒõlat?</h2>
    <div class="actions">
      <div id="btnBorrow" class="action borrow"><div class="emoji">üè†</div><div class="label">P≈Øjƒçuji si</div></div>
      <div id="btnReturn" class="action return"><div class="emoji">üè´</div><div class="label">Vrac√≠m</div></div>
    </div>
  </div>

  <!-- 3) KNIHA -->
  <div id="step-book" class="card hidden">
    <h2 class="step-title">3. Jakou knihu?</h2>
    <div class="big-emoji">üìñ</div>
    <input id="bookInput" class="input" placeholder="Napi≈° nebo naskenuj n√°zev knihy" autocomplete="off">
    <div style="height:10px"></div>
    <button id="scanBookBtn" class="btn">üì∑ Skenovat QR k√≥d knihy</button>
  </div>

  <!-- SKENER -->
  <div id="scanner" class="card">
    <h2 class="step-title">Skenov√°n√≠ QR k√≥du</h2>
    <div id="qr-region"></div>
    <div id="qr-instructions">Zamƒõ≈ôte QR k√≥d. Po naƒçten√≠ se sken ukonƒç√≠.</div>
    <div style="margin-top:10px; display:flex; gap:10px">
      <button id="cancelScan" class="btn btn-secondary">Zru≈°it</button>
      <button id="flipBtn" class="btn btn-secondary">P≈ôepnout kameru</button>
      <button id="torchBtn" class="btn btn-secondary">Sv√≠tilna</button>
    </div>
  </div>

  <div class="hint">Po potvrzen√≠ se aplikace vr√°t√≠ na krok 1. Z√°znamy se dƒõtem nezobrazuj√≠.</div>
</div>

<!-- MODAL POTVRZEN√ç -->
<div id="confirmModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div style="font-size:44px; margin-bottom:6px" id="modalEmoji">‚úÖ</div>
    <h3 id="confirmText">‚Äî</h3>
    <div class="muted">Z√°znam bude ulo≈æen a odesl√°n do Google Sheets.</div>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button id="okBtn" class="btn btn-ok">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* ===== KONFIGURACE ===== */
const WEBAPP_URL   = "PASTE_WEBAPP_URL_HERE";   // nap≈ô. https://script.google.com/macros/s/XXXXX/exec
const SHARED_SECRET = "CHANGE_ME_SECRET";       // stejn√© jako v Apps Scriptu
/* ======================= */

const STORAGE_ALL   = "sk_knihovna_all_v1";
const STORAGE_QUEUE = "sk_knihovna_queue_v1";

let state = { name:null, clazz:null, action:null, book:null };
let html5Qr, cameraId=null, torchOn=false;
let onScanResult = () => {};

const $ = s => document.querySelector(s);
const show = (el, yes=true) => el.classList.toggle('hidden', !yes);
const toast = (msg, ms=2200) => { const t=$('#toast'); t.textContent=msg; show(t,true); setTimeout(()=>show(t,false),ms); };

function parseStudent(raw){
  const parts = String(raw||'').split('|').map(s=>s.trim()).filter(Boolean);
  if(parts.length<2) return null;
  return { name:parts[0], clazz:parts[1] };
}
function resetUI(){
  state = { name:null, clazz:null, action:null, book:null };
  $('#studentInput').value = ""; $('#bookInput').value = ""; $('#studentPreview').textContent="";
  show($('#studentPreview'), false);
  show($('#step-student'), true); show($('#step-action'), false); show($('#step-book'), false);
  show($('#scanner'), false); stopScanner(); window.scrollTo({top:0,behavior:'smooth'});
}

function updateStudentPreview(){
  const p = parseStudent($('#studentInput').value);
  if(p){ $('#studentPreview').textContent = `≈Ω√°k: ${p.name} ‚Ä¢ T≈ô√≠da: ${p.clazz}`; show($('#studentPreview'), true); }
  else{ show($('#studentPreview'), false); }
}

function goAction(){
  const parsed = parseStudent($('#studentInput').value);
  if(!parsed){ toast("Zadej/naskenuj ≈æ√°ka ve tvaru: Jm√©no|T≈ô√≠da"); return; }
  state.name = parsed.name; state.clazz = parsed.clazz;
  show($('#step-student'), false); show($('#step-action'), true);
}
function goBook(){
  const v = $('#bookInput').value.trim();
  if(!v){ toast("Zadej/naskenuj n√°zev knihy."); return; }
  state.book = v; confirmModal();
}

/* ===== QR SCAN ===== */
async function startScanner(onText){
  show($('#scanner'), true);
  try{
    // 1) explicitnƒõ vy≈æ√°dej povolen√≠ (vyvol√° syst√©mov√Ω dialog, pokud je≈°tƒõ nebyl)
    const pre = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }
    });
    // hned uvolnit
    pre.getTracks().forEach(t=>t.stop());

    if(!html5Qr) html5Qr = new Html5Qrcode("qr-region");

    // 2) z√≠skej kamery a vyber "re√°lnou" (ne OBS / Screen / Virtual)
    let devices = await Html5Qrcode.getCameras();
    if(!devices || !devices.length){
      throw new Error("Nebyla nalezena ≈æ√°dn√° kamera.");
    }
    // preferuj zadn√≠, p≈ô√≠padnƒõ filtruj virtu√°ln√≠
    const isReal = d => !/virtual|obs|screen|capture/i.test(d.label);
    const back = devices.find(d => /back|rear|environment|zadn/i.test(d.label) && isReal(d));
    const firstReal = devices.find(isReal) || devices[0];
    const chosen = back || firstReal;

    console.log("Kamery:", devices);
    console.log("Pou≈æiju kameru:", chosen);

    // 3) spus≈• html5-qrcode
    await html5Qr.start(
      { deviceId: { exact: chosen.id } },
      { fps: 12, qrbox: { width: 250, height: 250 }, formatsToSupport:[ Html5QrcodeSupportedFormats.QR_CODE ] },
      decoded => { stopScanner(); onText(decoded.trim()); },
      _ => {}
    );

  }catch(e){
    console.error("Camera error:", e);
    const name = e?.name || "";
    const msg  = e?.message || String(e);
    let hint = "";
    if(name==="NotAllowedError")  hint = "Povolte kameru v prohl√≠≈æeƒçi (ikona z√°mku ‚Üí Kamera ‚Üí Povolit).";
    if(name==="NotFoundError")    hint = "Za≈ô√≠zen√≠ nem√° dostupnou kameru / je vypnut√°.";
    if(name==="NotReadableError") hint = "Kameru pou≈æ√≠v√° jin√° aplikace (Teams/Meet) nebo ji blokuje OS.";
    if(name==="SecurityError")    hint = "Str√°nka mus√≠ bƒõ≈æet p≈ôes HTTPS (GitHub Pages je OK).";
    toast(`Kamera: ${name||"Chyba"} ‚Äì ${msg}${hint ? " ‚Ä¢ " + hint : ""}`, 7000);
    show($('#scanner'), false);
  }
}
async function stopScanner(){
  try{ if(html5Qr && html5Qr.isScanning) await html5Qr.stop(); if(html5Qr) await html5Qr.clear(); }catch(e){}
}
$('#scanStudentBtn').onclick = ()=>{ onScanResult = txt=>{ $('#studentInput').value = txt; updateStudentPreview(); goAction(); }; startScanner(onScanResult); };
$('#scanBookBtn').onclick    = ()=>{ onScanResult = txt=>{ $('#bookInput').value   = txt; goBook(); }; startScanner(onScanResult); };
$('#cancelScan').onclick = ()=>{ stopScanner(); show($('#scanner'), false); };
$('#flipBtn').onclick    = async()=>{ if(!html5Qr) return; stopScanner(); startScanner(onScanResult); };
$('#torchBtn').onclick   = async()=>{ if(!html5Qr) return; try{ torchOn=!torchOn; await html5Qr.applyVideoConstraints({advanced:[{torch:torchOn}]}); }catch(_){ toast("Sv√≠tilna nen√≠ dostupn√°."); }};

/* ===== UI ud√°losti ===== */
$('#studentInput').addEventListener('input', updateStudentPreview);
$('#studentInput').addEventListener('keydown', e=>{ if(e.key==='Enter') goAction(); });
$('#bookInput').addEventListener('keydown', e=>{ if(e.key==='Enter') goBook(); });
$('#btnBorrow').onclick = ()=>{ state.action="P≈ÆJƒåKA"; show($('#step-action'), false); show($('#step-book'), true); };
$('#btnReturn').onclick = ()=>{ state.action="VRATKA";  show($('#step-action'), false); show($('#step-book'), true); };

/* ===== Potvrzen√≠ ===== */
function confirmModal(){
  const verb = state.action==='VRATKA' ? 'VR√ÅCENA' : 'P≈ÆJƒåENA';
  $('#modalEmoji').textContent = state.action==='VRATKA' ? '‚úÖ' : 'üì¶';
  $('#confirmText').textContent = `Kniha ‚Äû${state.book}‚Äú byla ${verb} na jm√©no ${state.name} (${state.clazz}).`;
  show($('#confirmModal'), true);
}
$('#okBtn').onclick = ()=>{ show($('#confirmModal'), false); saveAndQueue(); toast("Ulo≈æeno."); resetUI(); };

/* ===== Ulo≈æen√≠ + fronta + odes√≠l√°n√≠ ===== */
function getAll(){ return JSON.parse(localStorage.getItem(STORAGE_ALL) || "[]"); }
function setAll(a){ localStorage.setItem(STORAGE_ALL, JSON.stringify(a)); }
function getQueue(){ return JSON.parse(localStorage.getItem(STORAGE_QUEUE) || "[]"); }
function setQueue(a){ localStorage.setItem(STORAGE_QUEUE, JSON.stringify(a)); }

function saveAndQueue(){
  const rec = {
    id: crypto.randomUUID(),
    timestamp: new Date().toISOString(),
    student: state.name,
    clazz: state.clazz,
    action: state.action,
    book: state.book,
    device: navigator.userAgent||""
  };
  const all = getAll(); all.push(rec); setAll(all);
  const q = getQueue(); q.push(rec); setQueue(q);
  sendQueue(); // pokus hned
}

async function sendQueue(){
  const q = getQueue(); if(!q.length) return;
  for(const rec of [...q]){  // kopie pole
    try{
      await sendOne(rec);
      // √∫spƒõch ‚Üí odstranit z fronty
      const rest = getQueue().filter(x=>x.id!==rec.id); setQueue(rest);
    }catch(e){
      console.warn("Odesl√°n√≠ selhalo:", e.message);
      // ponech v queue; zkus√≠me pozdƒõji
    }
  }
}

async function sendOne(rec){
  if(!WEBAPP_URL || WEBAPP_URL.includes("PASTE_WEBAPP_URL_HERE")) throw new Error("Nenastaven WEBAPP_URL.");
  const res = await fetch(WEBAPP_URL, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ secret: SHARED_SECRET, record: rec })
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json();
  if(!data || !data.ok) throw new Error(data?.error || "Nezn√°m√° chyba serveru");
}

window.addEventListener('online', sendQueue);
setInterval(sendQueue, 15000); // ka≈æd√Ωch 15 s zkus doodeslat

// start
resetUI();
sendQueue(); // doodeslat hned po otev≈ôen√≠
</script>
</body>
</html>
