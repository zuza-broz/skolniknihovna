<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>≈†koln√≠ knihovna</title>

  <!-- QR scanner (UMD build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
  <script>
    // Kontrola naƒçten√≠ knihovny
    window.addEventListener('load', () => {
      if (typeof QrScanner !== 'undefined') {
        console.log('‚úÖ QR Scanner knihovna naƒçtena √∫spƒõ≈°nƒõ');
      } else {
        console.error('‚ùå QR Scanner knihovna se nenahr√°la');
      }
    });
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display: flex; justify-content: center; align-items: center;
      color: white; overflow: hidden;
    }
    .container { text-align: center; padding: 20px; max-width: 600px; width: 100%; }
    h1 { font-size: 2.5rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .screen { display: none; animation: fadeIn 0.5s ease-in; }
    .screen.active { display: block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    .big-button {
      background: rgba(255,255,255,0.2); border: 3px solid rgba(255,255,255,0.3);
      border-radius: 20px; padding: 40px 30px; margin: 20px; font-size: 1.8rem; color: white;
      cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); min-height: 150px; display: flex;
      flex-direction: column; justify-content: center; align-items: center; gap: 15px;
    }
    .big-button:hover { background: rgba(255,255,255,0.3); transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
    .big-button:active { transform: translateY(-2px); }
    .icon { font-size: 4rem; margin-bottom: 10px; }
    .two-buttons { display: flex; justify-content: space-around; flex-wrap: wrap; }
    .two-buttons .big-button { flex: 1; min-width: 250px; max-width: 280px; }
    #video, #video2 { width: 100%; max-width: 400px; height: 300px; border-radius: 15px; background: #333; margin: 20px auto; display: block; }
    .admin-link { position: fixed; top: 20px; right: 20px; color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.9rem; }
    .admin-link:hover { color: white; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index:1000; }
    .modal-content {
      position: absolute; top:50%; left:50%; transform: translate(-50%, -50%);
      background:white; color:#333; padding:30px; border-radius:15px; max-width:800px; width:90%; text-align:center;
    }
    .modal-content h2 { color:#333; margin-bottom:20px; }
    input {
      padding: 15px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 8px; margin: 10px;
      width: 200px; text-align: center;
    }
    .btn { background:#667eea; color:white; border:none; padding:15px 30px; border-radius:8px; font-size:1.1rem; cursor:pointer; margin:10px; }
    .btn:hover { background:#5a6fd8; }
    .admin-content { max-height: 400px; overflow-y: auto; margin: 20px 0; text-align:left; }
    .record { background:#f5f5f5; margin:10px 0; padding:15px; border-radius:8px; text-align:left; }
    .success { background:#4CAF50; color:white; padding:20px; border-radius:10px; margin:20px 0; font-size:1.3rem; }
    .error { background:#f44336; color:white; padding:20px; border-radius:10px; margin:20px 0; }
    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .big-button { font-size: 1.5rem; padding: 30px 20px; min-height: 120px; }
      .icon { font-size: 3rem; }
      .two-buttons { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="#" class="admin-link" onclick="showAdminLogin()">Administrace</a>

    <!-- √övodn√≠ obrazovka -->
    <div id="homeScreen" class="screen active">
      <h1>üìö ≈†koln√≠ knihovna</h1>
      <div class="big-button" onclick="startStudentScan()">
        <div class="icon">üë§</div>
        <div>Naskenuj sv≈Øj QR k√≥d</div>
      </div>
    </div>

    <!-- Skenov√°n√≠ ≈æ√°ka -->
    <div id="studentScanScreen" class="screen">
      <h1>Naskenuj sv√© jm√©no</h1>
      <div style="position: relative;">
        <video id="video" autoplay muted playsinline></video>
        <div id="scanOverlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:3px solid #00ff00; width:200px; height:200px; border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,0.3);"></div>
      </div>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="two-buttons" style="margin-top: 20px;">
        <div class="big-button" onclick="manualStudentInput()"><div>‚úçÔ∏è Zadat ruƒçnƒõ</div></div>
        <div class="big-button" onclick="goHome()"><div>üè† Zpƒõt dom≈Ø</div></div>
      </div>
    </div>

    <!-- V√Ωbƒõr akce -->
    <div id="actionScreen" class="screen">
      <h1 id="studentName">Ahoj, ≈æ√°ku!</h1>
      <div class="two-buttons">
        <div class="big-button" onclick="selectAction('vypujcka')">
          <div class="icon">üè†</div>
          <div>V√Ωp≈Øjƒçka</div>
        </div>
        <div class="big-button" onclick="selectAction('vratka')">
          <div class="icon">üè´</div>
          <div>Vratka</div>
        </div>
      </div>
      <div class="big-button" onclick="goHome()" style="margin-top: 20px;">
        <div>üè† Zpƒõt dom≈Ø</div>
      </div>
    </div>

    <!-- Skenov√°n√≠ knihy -->
    <div id="bookScanScreen" class="screen">
      <h1 id="actionTitle">Naskenuj knihu</h1>
      <div style="position: relative;">
        <video id="video2" autoplay muted playsinline></video>
        <div id="scanOverlay2" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:3px solid #00ff00; width:200px; height:200px; border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,0.3);"></div>
      </div>
      <canvas id="canvas2" style="display:none;"></canvas>
      <div class="two-buttons" style="margin-top: 20px;">
        <div class="big-button" onclick="manualBookInput()"><div>‚úçÔ∏è Zadat ruƒçnƒõ</div></div>
        <div class="big-button" onclick="goBack()"><div>‚Ü©Ô∏è Zpƒõt</div></div>
      </div>
    </div>

    <!-- Potvrzen√≠ -->
    <div id="confirmScreen" class="screen">
      <div id="confirmMessage" class="success"></div>
      <div class="big-button" onclick="goHome()"><div>‚úÖ OK</div></div>
    </div>
  </div>

  <!-- Admin p≈ôihl√°≈°en√≠ -->
  <div id="adminModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2>Administrace</h2>
      <input type="password" id="adminPassword" placeholder="Heslo" onkeypress="if(event.key==='Enter') adminLogin()">
      <br>
      <button class="btn" onclick="adminLogin()">P≈ôihl√°sit</button>
      <button class="btn" onclick="closeAdmin()">Zav≈ô√≠t</button>
    </div>
  </div>

  <!-- Admin panel -->
  <div id="adminPanel" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <h2>Administrace knihovny</h2>
      <div class="admin-content" id="adminContent"></div>
      <button class="btn" onclick="clearAllData()">Vymazat v≈°echna data</button>
      <button class="btn" onclick="exportData()">Exportovat data</button>
      <button class="btn" onclick="closeAdmin()">Zav≈ô√≠t</button>
    </div>
  </div>

  <!-- Ruƒçn√≠ zad√°n√≠ (jedin√Ω v√Ωskyt) -->
  <div id="manualModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2 id="manualTitle">Zadej √∫daje</h2>
      <input type="text" id="manualInput" placeholder="Zadej text" onkeypress="if(event.key==='Enter') submitManual()">
      <br>
      <button class="btn" onclick="submitManual()">Potvrdit</button>
      <button class="btn" onclick="closeManual()">Zru≈°it</button>
    </div>
  </div>

  <script>
    // =========================
    // Glob√°ln√≠ promƒõnn√©
    // =========================
    let currentStudent = '';
    let currentAction  = '';
    let isScanning     = false;

    // =========================
    // √ölo≈æi≈°tƒõ
    // =========================
    function saveRecord(student, book, action) {
      const records = JSON.parse(localStorage.getItem('libraryRecords') || '[]');
      const record = {
        id: Date.now(),
        student,
        book,
        action,
        timestamp: new Date().toLocaleString('cs-CZ')
      };
      records.push(record);
      localStorage.setItem('libraryRecords', JSON.stringify(records));
      return record;
    }

    function getRecords() {
      return JSON.parse(localStorage.getItem('libraryRecords') || '[]');
    }

    // =========================
    // Navigace
    // =========================
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function goHome() {
      stopScanning();
      currentStudent = '';
      currentAction  = '';
      showScreen('homeScreen');
    }

    function goBack() {
      stopScanning();
      showScreen('actionScreen');
    }

    // =========================
    // QR skenov√°n√≠
    // =========================
    function startStudentScan() {
      showScreen('studentScanScreen');
      startCamera('video', scanForStudent);
    }

    // !!! d≈Øle≈æit√©: vol√° se po kliknut√≠ na V√Ωp≈Øjƒçka/Vratka
    window.selectAction = function(action) {
      console.log('Kliknuto na:', action);
      currentAction = action;
      startBookScan();
    };

    function startBookScan() {
      console.log('startBookScan vol√°na, currentAction:', currentAction);
      stopScanning();
      showScreen('bookScanScreen');

      const title = currentAction === 'vypujcka'
        ? 'Naskenuj knihu k v√Ωp≈Øjƒçce'
        : 'Naskenuj knihu k vr√°cen√≠';
      document.getElementById('actionTitle').textContent = title;

      setTimeout(() => {
        console.log('Spou≈°t√≠m kameru pro knihu...');
        startCamera('video2', scanForBook);
      }, 200);
    }

    function startCamera(videoId, scanCallback) {
      const video = document.getElementById(videoId);
      if (!video) { console.error(`Video element ${videoId} neexistuje!`); return; }

      // Debug badge
      const debugDiv = document.createElement('div');
      debugDiv.id = 'qr-debug-' + videoId;
      debugDiv.style.position = 'absolute';
      debugDiv.style.top = '10px';
      debugDiv.style.left = '10px';
      debugDiv.style.background = 'rgba(0,0,0,0.7)';
      debugDiv.style.color = 'white';
      debugDiv.style.padding = '10px';
      debugDiv.style.borderRadius = '5px';
      debugDiv.style.fontSize = '14px';
      debugDiv.style.zIndex = '1000';
      debugDiv.style.maxWidth = '90%';
      debugDiv.innerHTML = `‚è≥ Spou≈°t√≠m QR scanner pro ${videoId}...`;
      document.body.appendChild(debugDiv);

      if (typeof QrScanner === 'undefined') {
        debugDiv.innerHTML = '‚ùå QR Scanner se nenahr√°l<br>üí° Pou≈æijte "Zadat ruƒçnƒõ"';
        debugDiv.style.background = 'rgba(200,0,0,0.8)';
        return;
      }

      const qrScanner = new QrScanner(
        video,
        (result) => {
          // QR naƒçten
          debugDiv.innerHTML = `üéâ QR K√ìD NAƒåTEN!<br><strong>${result.data}</strong>`;
          debugDiv.style.background = 'rgba(0,200,0,0.9)';
          debugDiv.style.fontSize = '16px';
          debugDiv.style.fontWeight = 'bold';

          qrScanner.stop();
          qrScanner.destroy();

          // Smazat debug a pokraƒçovat
          setTimeout(() => {
            if (document.body.contains(debugDiv)) document.body.removeChild(debugDiv);
            scanCallback(result.data);
          }, 800);
        },
        {
          returnDetailedScanResult: true,
          highlightScanRegion: true,
          highlightCodeOutline: true,
        }
      );

      qrScanner.start().then(() => {
        isScanning = true;
        debugDiv.innerHTML = `üì± QR Scanner aktivn√≠ pro ${videoId}<br>üîç Nasmƒõruj QR k√≥d na kameru<br>üì∑ Kamera hled√° QR k√≥dy...`;
        debugDiv.style.background = 'rgba(0,100,200,0.8)';

        // ulo≈æit referenci
        if (videoId === 'video') {
          window.currentQRScanner = qrScanner;
        } else {
          window.currentQRScanner2 = qrScanner;
        }
      }).catch(err => {
        debugDiv.innerHTML = `‚ùå Chyba QR Scanner: ${err.message}<br>üí° Pou≈æijte "Zadat ruƒçnƒõ"`;
        debugDiv.style.background = 'rgba(200,0,0,0.8)';
        console.error('QR Scanner chyba:', err);
      });
    }

    function stopScanning() {
      isScanning = false;

      // Zastavit oba scannery
      if (window.currentQRScanner) {
        try { window.currentQRScanner.stop(); window.currentQRScanner.destroy(); } catch(e){}
        window.currentQRScanner = null;
      }
      if (window.currentQRScanner2) {
        try { window.currentQRScanner2.stop(); window.currentQRScanner2.destroy(); } catch(e){}
        window.currentQRScanner2 = null;
      }

      // Smazat debug badge
      document.querySelectorAll('div[id*="qr-debug"]').forEach(div => {
        if (document.body.contains(div)) document.body.removeChild(div);
      });
    }

    function scanForStudent(qrData) {
      stopScanning();
      currentStudent = String(qrData || '').trim();
      document.getElementById('studentName').textContent = `Ahoj, ${currentStudent}!`;
      showScreen('actionScreen');
    }

    function scanForBook(qrData) {
      stopScanning();
      const bookName = String(qrData || '').trim();

      // Ulo≈æit z√°znam
      saveRecord(currentStudent, bookName, currentAction);

      // Potvrzen√≠
      const actionText = currentAction === 'vypujcka' ? 'VYP≈ÆJƒåENA' : 'VR√ÅCENA';
      document.getElementById('confirmMessage').innerHTML =
        `‚úÖ Kniha "<strong>${bookName}</strong>" byla <strong>${actionText}</strong> na jm√©no <strong>${currentStudent}</strong>.`;

      showScreen('confirmScreen');
    }

    // =========================
    // Ruƒçn√≠ zad√°v√°n√≠
    // =========================
    let manualInputType = ''; // 'student' | 'book'

    function manualStudentInput() {
      stopScanning();
      manualInputType = 'student';
      document.getElementById('manualTitle').textContent = 'Zadej jm√©no a t≈ô√≠du';
      document.getElementById('manualInput').placeholder = 'Nap≈ô: Jan Nov√°k 5.A';
      document.getElementById('manualInput').value = '';
      document.getElementById('manualModal').style.display = 'block';
      document.getElementById('manualInput').focus();
    }

    function manualBookInput() {
      stopScanning();
      manualInputType = 'book';
      document.getElementById('manualTitle').textContent = 'Zadej n√°zev knihy';
      document.getElementById('manualInput').placeholder = 'Nap≈ô: Harry Potter';
      document.getElementById('manualInput').value = '';
      document.getElementById('manualModal').style.display = 'block';
      document.getElementById('manualInput').focus();
    }

    function submitManual() {
      const input = document.getElementById('manualInput').value.trim();
      if (!input) { alert('Pros√≠m, zadejte text!'); return; }
      document.getElementById('manualModal').style.display = 'none';

      if (manualInputType === 'student') {
        scanForStudent(input);
      } else if (manualInputType === 'book') {
        scanForBook(input);
      }
    }

    function closeManual() {
      document.getElementById('manualModal').style.display = 'none';
      // Vr√°tit spr√°vnou obrazovku a znovu spustit scanner
      if (manualInputType === 'student') {
        showScreen('studentScanScreen');
        startCamera('video', scanForStudent);
      } else if (manualInputType === 'book') {
        showScreen('bookScanScreen');
        startCamera('video2', scanForBook);
      }
    }

    // =========================
    // Administrace
    // =========================
    function showAdminLogin() {
      document.getElementById('adminModal').style.display = 'block';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }

    function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === 'topol') {
        document.getElementById('adminModal').style.display = 'none';
        showAdminPanel();
      } else {
        alert('Nespr√°vn√© heslo!');
      }
    }

    function showAdminPanel() {
      const records = getRecords();
      const content = document.getElementById('adminContent');

      if (records.length === 0) {
        content.innerHTML = '<p>Zat√≠m ≈æ√°dn√© z√°znamy.</p>';
      } else {
        content.innerHTML = records.map(r => `
          <div class="record">
            <strong>${r.timestamp}</strong><br>
            ≈Ω√°k: ${r.student}<br>
            Kniha: ${r.book}<br>
            Akce: ${r.action.toUpperCase()}
          </div>
        `).reverse().join('');
      }
      document.getElementById('adminPanel').style.display = 'block';
    }

    function clearAllData() {
      if (confirm('Opravdu chcete vymazat v≈°echna data?')) {
        localStorage.removeItem('libraryRecords');
        alert('V≈°echna data byla vymaz√°na.');
        showAdminPanel();
      }
    }

    function exportData() {
      const records = getRecords();
      if (records.length === 0) { alert('≈Ω√°dn√° data k exportu.'); return; }

      const csv = 'Datum,ƒåas,≈Ω√°k,Kniha,Akce\n' + records.map(r => {
        // cs-CZ toLocaleString: "18. 8. 2025 14:05:00"
        const parts = r.timestamp.split(' ');
        const datum = parts.slice(0, parts.length - 1).join(' '); // zachy≈• datum i p≈ô√≠padn√© mezerov√°n√≠
        const cas = parts[parts.length - 1] || '';
        return `${datum},${cas},${r.student},${r.book},${r.action}`;
      }).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `knihovna_export_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function closeAdmin() {
      document.getElementById('adminModal').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
    }

    // =========================
    // Init
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('touchstart', () => {
        const link = document.querySelector('.admin-link');
        if (link) link.style.opacity = '0.3';
      });
    });
  </script>
</body>
</html>
